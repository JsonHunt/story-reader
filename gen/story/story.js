// Generated by CoffeeScript 1.9.0
(function() {
  var StoryController, imageService, mediaService, services, storageService, storyService;

  storyService = require('./../story-service');

  mediaService = require('./../media-service');

  imageService = require('./../image-service');

  storageService = require('./../storage-service');

  module.exports = StoryController = function($scope, $rootScope, $location, $routeParams, $timeout, $http, $cordovaFile, $cordovaFileTransfer, $cordovaCamera) {
    console.log("Story ID: " + $routeParams.id);
    storyService.selectStory(parseInt($routeParams.id));
    $scope.pages = storyService.getPages();
    $scope.pageIndex = 0;
    $scope.page = $scope.pages[0];
    if ($rootScope.openInEditMode === true) {
      $scope.textEdit = true;
      $rootScope.openInEditMode = false;
      setTimeout(function() {
        return $('#pagetext').focus();
      }, 50);
    }
    $scope.isStart = function() {
      return $scope.pageIndex === 0;
    };
    $scope.isEnd = function() {
      return $scope.pageIndex + 1 >= $scope.pages.length;
    };
    $scope.stopMedia = function() {
      return mediaService.stop();
    };
    $scope.nextPage = function() {
      mediaService.stop();
      if (!this.isEnd()) {
        $scope.pageIndex++;
        return $scope.page = $scope.pages[$scope.pageIndex];
      }
    };
    $scope.prevPage = function() {
      mediaService.stop();
      if (!this.isStart()) {
        $scope.pageIndex--;
        return $scope.page = $scope.pages[$scope.pageIndex];
      }
    };
    $scope.home = function() {
      return $scope.goto('');
    };
    $scope.toggleOptions = function() {
      mediaService.stop();
      return $scope.options = !$scope.options;
    };
    $scope.toggleEditPageText = function() {
      $scope.textEdit = !$scope.textEdit;
      if ($scope.textEdit) {
        return setTimeout(function() {
          return $('#pagetext').focus();
        }, 50);
      }
    };
    $scope.toggleEditMode = function() {
      if ($scope.mode === 'edit') {
        return $scope.mode = 'read';
      } else {
        return $scope.mode = 'edit';
      }
    };
    $scope.deletePage = function() {
      if ($scope.pages.length === 1) {
        return;
      }
      storyService.removePage($scope.page.id);
      $scope.confirmDeletePage = false;
      if ($scope.pageIndex >= $scope.pages.length) {
        $scope.pageIndex--;
      }
      return $scope.page = $scope.pages[$scope.pageIndex];
    };
    $scope.addPage = function() {
      var pageNumber;
      pageNumber = $scope.pages.length + 1;
      storyService.addPage("");
      $scope.textEdit = true;
      $scope.nextPage();
      return setTimeout(function() {
        return $('#pagetext').focus();
      }, 50);
    };
    $scope.savePage = function() {
      storyService.savePage($scope.page);
      console.log("Page saved");
      return $scope.textEdit = false;
    };
    $scope.googleImage = function() {
      $scope.imageSearch = true;
      $scope.imageQuery = $scope.page.text;
      return imageService.findImagesFor($scope.imageQuery, function(error, results) {
        return $scope.searchResults = results;
      });
    };
    $scope.refreshImageSearch = function() {
      return imageService.findImagesFor($scope.imageQuery, function(error, results) {
        return $scope.searchResults = results;
      });
    };
    $scope.selectImage = function(img) {
      $scope.imageSearch = false;
      $scope.page.imageURL = img.link;
      return imageService.saveImage(img.link, "image-" + $scope.page.id + ".jpg", function(localURL) {
        $scope.page.localImageURL = localURL;
        return $scope.savePage();
      });
    };
    $scope.select = function(word) {
      if (_.contains($scope.punctuation, word)) {
        return;
      }
      this.word = storyService.getWord(word);
      this.wordImageURL = mediaService.getURL(this.word.imagePath);
      if (!$scope.showOptions) {
        return $scope.read(word);
      }
    };
    return $scope.read = function(word) {
      mediaService.stop();
      if (word === void 0) {
        return;
      }
      if (this.reading === word) {
        return delete reading;
      } else {
        this.reading = word;
        return mediaService.play(this.word.recordingPath, function() {
          return $scope.$apply(function() {
            return delete $scope.word;
          });
        });
      }
    };
  };

  services = ['$scope', '$rootScope', '$location', '$routeParams', '$timeout', '$http'];

  if (this.isPhoneGap) {
    services.push('$cordovaFile');
    services.push('$cordovaFileTransfer');
    services.push('$cordovaCamera');
  }

  StoryController.$inject = services;

}).call(this);
